{"ksql": "SET 'auto.offset.reset' = 'earliest';\n\nCREATE TABLE reference (\n    reference_id string PRIMARY KEY,\n    curie string,\n    abstract string,\n    category string,\n    citation_id string,\n    date_arrived_in_pubmed string,\n    date_created bigint,\n    date_last_modified_in_pubmed string,\n    date_published string,\n    date_published_start string,\n    date_published_end string,\n    date_updated bigint,\n    issue_name string,\n    keywords array<string>,\n    language string,\n    open_access boolean,\n    page_range string,\n    plain_language_abstract string,\n    publisher string,\n    pubmed_abstract_languages array<string>,\n    pubmed_publication_status string,\n    pubmed_types array<string>,\n    resource_id bigint,\n    title string,\n    volume string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.reference',\n    VALUE_FORMAT='json'\n  );\n\nCREATE TABLE cross_reference (\n    ROWKEY string PRIMARY KEY,\n    reference_id string,\n    curie string,\n    is_obsolete boolean\n  ) WITH (\n    KAFKA_TOPIC='abc.public.cross_reference',\n    VALUE_FORMAT='json'\n  );\n\nCREATE TABLE author (\n    ROWKEY string PRIMARY KEY,\n    reference_id string,\n    orcid string,\n    name string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.author',\n    VALUE_FORMAT='json'\n  );\n\nCREATE TABLE mod (\n    mod_id string PRIMARY KEY,\n    abbreviation string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.mod',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n  );\n\nCREATE TABLE mod_corpus_association (\n    mod_corpus_association_id string PRIMARY KEY,\n    mod_id string,\n    reference_id string,\n    corpus boolean\n  ) WITH (\n    KAFKA_TOPIC='abc.public.mod_corpus_association',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n  );\n\nCREATE TABLE obsolete_reference_curie (\n    obsolete_id string PRIMARY KEY,\n    curie string,\n    new_id string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.obsolete_reference_curie',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n  );\n\nCREATE TABLE citation (\n    citation_id string PRIMARY KEY,\n    citation string,\n    short_citation string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.citation',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n);\n\nCREATE TABLE referencetype(\n    referencetype_id string PRIMARY KEY,\n    label string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.referencetype',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n);\n\nCREATE TABLE mod_referencetype(\n    mod_referencetype_id string PRIMARY KEY,\n    mod_id string,\n    referencetype_id string,\n    display_order string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.mod_referencetype',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n);\n\nCREATE TABLE reference_mod_referencetype(\n    reference_mod_referencetype_id string PRIMARY KEY,\n    reference_id string,\n    mod_referencetype_id string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.reference_mod_referencetype',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n);\n\nCREATE TABLE topic_entity_tag_source(\n    topic_entity_tag_source_id string PRIMARY KEY,\n    source_method string,\n    data_provider string,\n    source_evidence_assertion string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.topic_entity_tag_source',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n);\n\nCREATE TABLE topic_entity_tag(\n    topic_entity_tag_id string PRIMARY KEY,\n    reference_id string,\n    \\\"topic\\\" string,\n    entity_type string,\n    date_created string,\n    date_updated string,\n    created_by string,\n    updated_by string,\n    entity string,\n    entity_published_as string,\n    species string,\n    display_tag string,\n    confidence_level string,\n    negated boolean,\n    note string,\n    topic_entity_tag_source_id string,\n    novel_topic_data boolean,\n    entity_id_validation string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.topic_entity_tag',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n);\n\nCREATE TABLE topic_entity_tag_with_source AS\n    SELECT\n    topic_entity_tag.topic_entity_tag_id \\\"TOPIC_ENTITY_TAG_ID\\\",\n    topic_entity_tag.reference_id,\n    topic_entity_tag.\\\"topic\\\" \\\"TOPIC\\\",\n    topic_entity_tag.entity_type,\n    topic_entity_tag.date_created,\n    topic_entity_tag.date_updated,\n    topic_entity_tag.created_by,\n    topic_entity_tag.updated_by,\n    topic_entity_tag.entity,\n    topic_entity_tag.entity_published_as,\n    topic_entity_tag.species,\n    topic_entity_tag.display_tag,\n    topic_entity_tag.confidence_level,\n    topic_entity_tag.negated,\n    topic_entity_tag.note,\n    topic_entity_tag.topic_entity_tag_source_id,\n    topic_entity_tag.novel_topic_data,\n    topic_entity_tag.entity_id_validation,\n    topic_entity_tag_source.source_method,\n    topic_entity_tag_source.data_provider,\n    topic_entity_tag_source.source_evidence_assertion,\n\n    CASE\n      WHEN topic_entity_tag_source.source_evidence_assertion IN ('ATP:0000036', 'ATP:0000035')\n        THEN 'ECO:0006155'\n      ELSE 'ECO:0007669'\n    END AS source_evidence_assertion_group\n\n    FROM topic_entity_tag topic_entity_tag\n    JOIN topic_entity_tag_source topic_entity_tag_source ON\n    topic_entity_tag.topic_entity_tag_source_id = topic_entity_tag_source.topic_entity_tag_source_id\n    EMIT CHANGES;\n\nCREATE TABLE topic_entity_tags AS\n    SELECT reference_id \\\"REFERENCE_ID\\\",\n    collect_list(map('topic':=\\\"TOPIC\\\", 'entity_type':=entity_type, 'entity':=entity, 'entity_published_as':=entity_published_as, 'species':=species, 'display_tag':=display_tag, 'confidence_level':=confidence_level, 'negated':=cast(negated as string), 'novel_topic_data':=cast(novel_topic_data as string), 'source_method':=source_method, 'data_provider':= data_provider, 'source_evidence_assertion':=source_evidence_assertion, 'source_evidence_assertion_group':=source_evidence_assertion_group)) \\\"TOPIC_ENTITY_TAGS\\\"\n    FROM topic_entity_tag_with_source\n    GROUP BY reference_id\n    EMIT CHANGES;\n\nCREATE TABLE cross_references AS\n    SELECT reference_id \\\"REFERENCE_ID\\\",\n    collect_list(map('curie':=curie, 'is_obsolete':=cast(is_obsolete as string))) \\\"CROSS_REFERENCES\\\"\n    FROM cross_reference\n    GROUP BY reference_id\n    EMIT CHANGES;\n\nCREATE TABLE authors AS\n    SELECT reference_id \\\"REFERENCE_ID\\\",\n    collect_list(map('name':=name, 'orcid':=orcid)) \\\"AUTHORS\\\"\n    FROM author\n    GROUP BY reference_id\n    EMIT CHANGES;\n\nCREATE TABLE mods_in_corpus AS\n    SELECT mod_corpus_association.reference_id \\\"REFERENCE_ID\\\",\n    collect_list(mod.abbreviation) \\\"MODS_IN_CORPUS\\\"\n    FROM mod_corpus_association\n    JOIN mod\n    ON mod_corpus_association.mod_id = mod.mod_id\n    WHERE mod_corpus_association.corpus = true\n    GROUP BY mod_corpus_association.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE mods_needs_review AS\n    SELECT mod_corpus_association.reference_id \\\"REFERENCE_ID\\\",\n    collect_list(mod.abbreviation) \\\"MODS_NEEDS_REVIEW\\\"\n    FROM mod_corpus_association\n    JOIN mod\n    ON mod_corpus_association.mod_id = mod.mod_id\n    WHERE mod_corpus_association.corpus is NULL\n    GROUP BY mod_corpus_association.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE mods_in_corpus_or_needs_review AS\n    SELECT mod_corpus_association.reference_id \\\"REFERENCE_ID\\\",\n    collect_list(mod.abbreviation) \\\"MODS_IN_CORPUS_OR_NEEDS_REVIEW\\\"\n    FROM mod_corpus_association\n    JOIN mod\n    ON mod_corpus_association.mod_id = mod.mod_id\n    WHERE mod_corpus_association.corpus is NULL OR mod_corpus_association.corpus = true\n    GROUP BY mod_corpus_association.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE mod_referencetype_referencetype AS\n    SELECT mod_referencetype.mod_referencetype_id \\\"MOD_REFERENCETYPE_ID\\\",\n    referencetype.label \\\"LABEL\\\"\n    FROM mod_referencetype\n    JOIN referencetype\n    ON mod_referencetype.referencetype_id = referencetype.referencetype_id\n    EMIT CHANGES;\n\nCREATE TABLE mod_referencetype_referencetype_full AS\n    SELECT reference_mod_referencetype.reference_id \\\"REFERENCE_ID\\\",\n    collect_list(mod_referencetype_referencetype.label) \\\"LABEL\\\"\n    FROM reference_mod_referencetype\n    JOIN mod_referencetype_referencetype\n    ON mod_referencetype_referencetype.mod_referencetype_id = reference_mod_referencetype.mod_referencetype_id\n    GROUP BY reference_mod_referencetype.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE obsolete_curies AS\n    SELECT new_id \\\"REFERENCE_ID\\\",\n    collect_list(curie) \\\"OBSOLETE_CURIES\\\"\n    FROM obsolete_reference_curie\n    GROUP BY new_id\n    EMIT CHANGES;\n\nCREATE TABLE reference_with_citation AS\n    SELECT\n    reference.reference_id \\\"REFERENCE_ID\\\",\n    reference.curie,\n    reference.abstract,\n    reference.category,\n    NULLIF(reference.date_arrived_in_pubmed, '') \\\"DATE_ARRIVED_IN_PUBMED\\\",\n    reference.date_created,\n    NULLIF(reference.date_last_modified_in_pubmed, '') \\\"DATE_LAST_MODIFIED_IN_PUBMED\\\",\n    reference.date_published,\n    reference.date_published_start,\n    reference.date_published_end,\n    reference.date_updated,\n    reference.issue_name,\n    reference.keywords,\n    reference.language,\n    reference.open_access,\n    reference.page_range,\n    reference.plain_language_abstract,\n    reference.publisher,\n    reference.pubmed_abstract_languages,\n    reference.pubmed_publication_status,\n    reference.pubmed_types,\n    reference.resource_id,\n    reference.title,\n    reference.volume,\n    citation.citation \\\"CITATION\\\",\n    citation.short_citation \\\"SHORT_CITATION\\\"\n    FROM reference reference\n    JOIN citation citation ON\n    reference.citation_id = citation.citation_id\n    EMIT CHANGES;\n\nCREATE TABLE reference_xref AS\n    SELECT\n    reference.reference_id \\\"REFERENCE_ID\\\",\n    reference.curie,\n    reference.abstract,\n    reference.category,\n    NULLIF(reference.date_arrived_in_pubmed, '') \\\"DATE_ARRIVED_IN_PUBMED\\\",\n    reference.date_created,\n    NULLIF(reference.date_last_modified_in_pubmed, '') \\\"DATE_LAST_MODIFIED_IN_PUBMED\\\",\n    reference.date_published,\n    reference.date_published_start,\n    reference.date_published_end,\n    reference.date_updated,\n    reference.issue_name,\n    reference.keywords,\n    reference.language,\n    reference.open_access,\n    reference.page_range,\n    reference.plain_language_abstract,\n    reference.publisher,\n    reference.pubmed_abstract_languages,\n    reference.pubmed_publication_status,\n    reference.pubmed_types,\n    reference.resource_id,\n    reference.title,\n    reference.volume,\n    reference.citation,\n    reference.short_citation,\n    cross_references.cross_references\n    FROM reference_with_citation reference\n    LEFT OUTER JOIN cross_references cross_references ON\n    reference.reference_id = cross_references.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE reference_xref_author AS\n    SELECT\n    reference_xref.reference_id \\\"REFERENCE_ID\\\",\n    reference_xref.curie,\n    reference_xref.abstract,\n    reference_xref.category,\n    reference_xref.date_arrived_in_pubmed,\n    reference_xref.date_created,\n    reference_xref.date_last_modified_in_pubmed,\n    reference_xref.date_published,\n    reference_xref.date_published_start,\n    reference_xref.date_published_end,\n    reference_xref.date_updated,\n    reference_xref.issue_name,\n    reference_xref.keywords,\n    reference_xref.language,\n    reference_xref.open_access,\n    reference_xref.page_range,\n    reference_xref.plain_language_abstract,\n    reference_xref.publisher,\n    reference_xref.pubmed_abstract_languages,\n    reference_xref.pubmed_publication_status,\n    reference_xref.pubmed_types,\n    reference_xref.resource_id,\n    reference_xref.title,\n    reference_xref.volume,\n    reference_xref.citation,\n    reference_xref.short_citation,\n    reference_xref.cross_references,\n    authors.authors\n    FROM reference_xref reference_xref\n    LEFT OUTER JOIN authors authors ON\n    reference_xref.reference_id = authors.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE reference_xref_author_mods_in_corpus AS\n    SELECT\n    reference_xref_author.reference_id \\\"REFERENCE_ID\\\",\n    reference_xref_author.curie,\n    reference_xref_author.abstract,\n    reference_xref_author.category,\n    reference_xref_author.date_arrived_in_pubmed,\n    reference_xref_author.date_created,\n    reference_xref_author.date_last_modified_in_pubmed,\n    reference_xref_author.date_published,\n    reference_xref_author.date_published_start,\n    reference_xref_author.date_published_end,\n    reference_xref_author.date_updated,\n    reference_xref_author.issue_name,\n    reference_xref_author.keywords,\n    reference_xref_author.language,\n    reference_xref_author.open_access,\n    reference_xref_author.page_range,\n    reference_xref_author.plain_language_abstract,\n    reference_xref_author.publisher,\n    reference_xref_author.pubmed_abstract_languages,\n    reference_xref_author.pubmed_publication_status,\n    reference_xref_author.pubmed_types,\n    reference_xref_author.resource_id,\n    reference_xref_author.title,\n    reference_xref_author.volume,\n    reference_xref_author.citation,\n    reference_xref_author.short_citation,\n    reference_xref_author.cross_references,\n    reference_xref_author.authors,\n    mods_in_corpus.mods_in_corpus\n    FROM reference_xref_author reference_xref_author\n    LEFT OUTER JOIN mods_in_corpus mods_in_corpus ON\n    reference_xref_author.reference_id = mods_in_corpus.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE reference_xref_author_mods_in_corpus_mods_needs_review AS\n    SELECT\n    reference_xref_author_mods_in_corpus.reference_id \\\"REFERENCE_ID\\\",\n    reference_xref_author_mods_in_corpus.curie,\n    reference_xref_author_mods_in_corpus.abstract,\n    reference_xref_author_mods_in_corpus.category,\n    reference_xref_author_mods_in_corpus.date_arrived_in_pubmed,\n    reference_xref_author_mods_in_corpus.date_created,\n    reference_xref_author_mods_in_corpus.date_last_modified_in_pubmed,\n    reference_xref_author_mods_in_corpus.date_published,\n    reference_xref_author_mods_in_corpus.date_published_start,\n    reference_xref_author_mods_in_corpus.date_published_end,\n    reference_xref_author_mods_in_corpus.date_updated,\n    reference_xref_author_mods_in_corpus.issue_name,\n    reference_xref_author_mods_in_corpus.keywords,\n    reference_xref_author_mods_in_corpus.language,\n    reference_xref_author_mods_in_corpus.open_access,\n    reference_xref_author_mods_in_corpus.page_range,\n    reference_xref_author_mods_in_corpus.plain_language_abstract,\n    reference_xref_author_mods_in_corpus.publisher,\n    reference_xref_author_mods_in_corpus.pubmed_abstract_languages,\n    reference_xref_author_mods_in_corpus.pubmed_publication_status,\n    reference_xref_author_mods_in_corpus.pubmed_types,\n    reference_xref_author_mods_in_corpus.resource_id,\n    reference_xref_author_mods_in_corpus.title,\n    reference_xref_author_mods_in_corpus.volume,\n    reference_xref_author_mods_in_corpus.citation,\n    reference_xref_author_mods_in_corpus.short_citation,\n    reference_xref_author_mods_in_corpus.cross_references,\n    reference_xref_author_mods_in_corpus.authors,\n    reference_xref_author_mods_in_corpus.mods_in_corpus,\n    mods_needs_review.mods_needs_review\n    FROM reference_xref_author_mods_in_corpus reference_xref_author_mods_in_corpus\n    LEFT OUTER JOIN mods_needs_review mods_needs_review ON\n    reference_xref_author_mods_in_corpus.reference_id = mods_needs_review.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE reference_xref_all_mods_corpus AS\n    SELECT\n    reference_xref_author_mods_in_corpus_mods_needs_review.reference_id \\\"REFERENCE_ID\\\",\n    reference_xref_author_mods_in_corpus_mods_needs_review.curie,\n    reference_xref_author_mods_in_corpus_mods_needs_review.abstract,\n    reference_xref_author_mods_in_corpus_mods_needs_review.category,\n    reference_xref_author_mods_in_corpus_mods_needs_review.date_arrived_in_pubmed,\n    reference_xref_author_mods_in_corpus_mods_needs_review.date_created,\n    reference_xref_author_mods_in_corpus_mods_needs_review.date_last_modified_in_pubmed,\n    reference_xref_author_mods_in_corpus_mods_needs_review.date_published,\n    reference_xref_author_mods_in_corpus_mods_needs_review.date_published_start,\n    reference_xref_author_mods_in_corpus_mods_needs_review.date_published_end,\n    reference_xref_author_mods_in_corpus_mods_needs_review.date_updated,\n    reference_xref_author_mods_in_corpus_mods_needs_review.issue_name,\n    reference_xref_author_mods_in_corpus_mods_needs_review.keywords,\n    reference_xref_author_mods_in_corpus_mods_needs_review.language,\n    reference_xref_author_mods_in_corpus_mods_needs_review.open_access,\n    reference_xref_author_mods_in_corpus_mods_needs_review.page_range,\n    reference_xref_author_mods_in_corpus_mods_needs_review.plain_language_abstract,\n    reference_xref_author_mods_in_corpus_mods_needs_review.publisher,\n    reference_xref_author_mods_in_corpus_mods_needs_review.pubmed_abstract_languages,\n    reference_xref_author_mods_in_corpus_mods_needs_review.pubmed_publication_status,\n    reference_xref_author_mods_in_corpus_mods_needs_review.pubmed_types,\n    reference_xref_author_mods_in_corpus_mods_needs_review.resource_id,\n    reference_xref_author_mods_in_corpus_mods_needs_review.title,\n    reference_xref_author_mods_in_corpus_mods_needs_review.volume,\n    reference_xref_author_mods_in_corpus_mods_needs_review.citation,\n    reference_xref_author_mods_in_corpus_mods_needs_review.short_citation,\n    reference_xref_author_mods_in_corpus_mods_needs_review.cross_references,\n    reference_xref_author_mods_in_corpus_mods_needs_review.authors,\n    reference_xref_author_mods_in_corpus_mods_needs_review.mods_in_corpus,\n    reference_xref_author_mods_in_corpus_mods_needs_review.mods_needs_review,\n    mods_in_corpus_or_needs_review.mods_in_corpus_or_needs_review\n    FROM reference_xref_author_mods_in_corpus_mods_needs_review reference_xref_author_mods_in_corpus_mods_needs_review\n    LEFT OUTER JOIN mods_in_corpus_or_needs_review mods_in_corpus_or_needs_review ON\n    reference_xref_author_mods_in_corpus_mods_needs_review.reference_id = mods_in_corpus_or_needs_review.reference_id\n    EMIT CHANGES;\n\nCREATE TABLE reference_obsolete_curies AS SELECT\n    reference_xref_all_mods_corpus.reference_id \\\"REFERENCE_ID\\\",\n    reference_xref_all_mods_corpus.curie,\n    reference_xref_all_mods_corpus.abstract,\n    reference_xref_all_mods_corpus.category,\n    reference_xref_all_mods_corpus.date_arrived_in_pubmed,\n    reference_xref_all_mods_corpus.date_created,\n    reference_xref_all_mods_corpus.date_last_modified_in_pubmed,\n    reference_xref_all_mods_corpus.date_published,\n    reference_xref_all_mods_corpus.date_published_start,\n    reference_xref_all_mods_corpus.date_published_end,\n    reference_xref_all_mods_corpus.date_updated,\n    reference_xref_all_mods_corpus.issue_name,\n    reference_xref_all_mods_corpus.keywords,\n    reference_xref_all_mods_corpus.language,\n    reference_xref_all_mods_corpus.open_access,\n    reference_xref_all_mods_corpus.page_range,\n    reference_xref_all_mods_corpus.plain_language_abstract,\n    reference_xref_all_mods_corpus.publisher,\n    reference_xref_all_mods_corpus.pubmed_abstract_languages,\n    reference_xref_all_mods_corpus.pubmed_publication_status,\n    reference_xref_all_mods_corpus.pubmed_types,\n    reference_xref_all_mods_corpus.resource_id,\n    reference_xref_all_mods_corpus.title,\n    reference_xref_all_mods_corpus.volume,\n    reference_xref_all_mods_corpus.citation,\n    reference_xref_all_mods_corpus.short_citation,\n    reference_xref_all_mods_corpus.cross_references,\n    reference_xref_all_mods_corpus.authors,\n    reference_xref_all_mods_corpus.mods_in_corpus,\n    reference_xref_all_mods_corpus.mods_needs_review,\n    reference_xref_all_mods_corpus.mods_in_corpus_or_needs_review,\n    obsolete_curies.obsolete_curies\n    FROM reference_xref_all_mods_corpus reference_xref_all_mods_corpus\n    LEFT OUTER JOIN obsolete_curies obsolete_curies ON\n    reference_xref_all_mods_corpus.reference_id = obsolete_curies.reference_id;\n\nCREATE TABLE reference_mod_reference_types AS SELECT\n    reference_obsolete_curies.reference_id \\\"REFERENCE_ID\\\",\n    reference_obsolete_curies.curie,\n    reference_obsolete_curies.abstract,\n    reference_obsolete_curies.category,\n    reference_obsolete_curies.date_arrived_in_pubmed,\n    reference_obsolete_curies.date_created,\n    reference_obsolete_curies.date_last_modified_in_pubmed,\n    reference_obsolete_curies.date_published,\n    reference_obsolete_curies.date_published_start,\n    reference_obsolete_curies.date_published_end,\n    reference_obsolete_curies.date_updated,\n    reference_obsolete_curies.issue_name,\n    reference_obsolete_curies.keywords,\n    reference_obsolete_curies.language,\n    reference_obsolete_curies.open_access,\n    reference_obsolete_curies.page_range,\n    reference_obsolete_curies.plain_language_abstract,\n    reference_obsolete_curies.publisher,\n    reference_obsolete_curies.pubmed_abstract_languages,\n    reference_obsolete_curies.pubmed_publication_status,\n    reference_obsolete_curies.pubmed_types,\n    reference_obsolete_curies.resource_id,\n    reference_obsolete_curies.title,\n    reference_obsolete_curies.volume,\n    reference_obsolete_curies.citation,\n    reference_obsolete_curies.short_citation,\n    reference_obsolete_curies.cross_references,\n    reference_obsolete_curies.authors,\n    reference_obsolete_curies.mods_in_corpus,\n    reference_obsolete_curies.mods_needs_review,\n    reference_obsolete_curies.mods_in_corpus_or_needs_review,\n    reference_obsolete_curies.obsolete_curies,\n    mod_referencetype_referencetype_full.label\n    FROM reference_obsolete_curies reference_obsolete_curies\n    LEFT OUTER JOIN mod_referencetype_referencetype_full mod_referencetype_referencetype_full ON\n    reference_obsolete_curies.reference_id = mod_referencetype_referencetype_full.reference_id;\n\nCREATE TABLE reference_workflow_tag(\n    reference_workflow_tag_id string PRIMARY KEY,\n    reference_id string,\n    workflow_tag_id string,\n    mod_id string,\n    created_by string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.workflow_tag',\n    VALUE_FORMAT='json',\n    KEY_FORMAT='json'\n);\n\nCREATE TABLE reference_workflow_tag_with_mod AS\n    SELECT\n        reference_workflow_tag.reference_workflow_tag_id AS REFERENCE_WORKFLOW_TAG_ID,\n        reference_workflow_tag.reference_id,\n        reference_workflow_tag.workflow_tag_id,\n        mod.abbreviation AS mod_abbreviation,\n        reference_workflow_tag.created_by\n    FROM reference_workflow_tag\n    JOIN mod\n        ON reference_workflow_tag.mod_id = mod.mod_id;\n\nCREATE TABLE reference_workflow_tags AS\n    SELECT reference_workflow_tag_with_mod.reference_id \\\"REFERENCE_ID\\\",\n    collect_list(map('workflow_tag_id':=workflow_tag_id, 'mod_abbreviation':= mod_abbreviation)) \\\"WORKFLOW_TAGS\\\"\n    FROM reference_workflow_tag_with_mod\n    GROUP BY reference_workflow_tag_with_mod.reference_id\n    EMIT CHANGES;\n\n-- Create tables for new public index tables\nCREATE TABLE reference_relation (\n    ROWKEY string PRIMARY KEY,\n    reference_id_from string,\n    reference_id_to string,\n    reference_relation_type string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.reference_relation',\n    VALUE_FORMAT='json'\n  );\n\nCREATE TABLE copyright_license (\n    copyright_license_id string PRIMARY KEY,\n    reference_id string,\n    copyright_license_text string,\n    copyright_license_url string,\n    open_access boolean\n  ) WITH (\n    KAFKA_TOPIC='abc.public.copyright_license',\n    VALUE_FORMAT='json'\n  );\n\nCREATE TABLE mesh_detail (\n    mesh_detail_id string PRIMARY KEY,\n    reference_id string,\n    mesh_heading_term string,\n    mesh_qualifier_term string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.mesh_detail',\n    VALUE_FORMAT='json'\n  );\n\nCREATE TABLE resource (\n    resource_id string PRIMARY KEY,\n    title string,\n    iso_abbreviation string,\n    medline_abbreviation string,\n    issn_print string,\n    issn_electronic string\n  ) WITH (\n    KAFKA_TOPIC='abc.public.resource',\n    VALUE_FORMAT='json'\n  );\n\n-- Aggregate new tables for public index\nCREATE TABLE reference_relations AS\n    SELECT reference_id_from \\\"REFERENCE_ID\\\",\n    collect_list(map('reference_id_to':=reference_id_to, 'reference_relation_type':=reference_relation_type)) \\\"RELATIONS\\\"\n    FROM reference_relation\n    GROUP BY reference_id_from\n    EMIT CHANGES;\n\nCREATE TABLE copyright_licenses AS\n    SELECT reference_id \\\"REFERENCE_ID\\\",\n    collect_list(map('copyright_license_text':=copyright_license_text, 'copyright_license_url':=copyright_license_url, 'open_access':=cast(open_access as string))) \\\"COPYRIGHT_LICENSE\\\"\n    FROM copyright_license\n    GROUP BY reference_id\n    EMIT CHANGES;\n\nCREATE TABLE mesh_terms AS\n    SELECT reference_id \\\"REFERENCE_ID\\\",\n    collect_list(map('mesh_heading_term':=mesh_heading_term, 'mesh_qualifier_term':=mesh_qualifier_term)) \\\"MESH_TERMS\\\"\n    FROM mesh_detail\n    GROUP BY reference_id\n    EMIT CHANGES;\n\nCREATE TABLE reference_with_resource AS\n    SELECT\n    reference_with_citation.REFERENCE_ID \\\"REFERENCE_ID\\\",\n    reference_with_citation.curie,\n    reference_with_citation.abstract,\n    reference_with_citation.category,\n    reference_with_citation.DATE_ARRIVED_IN_PUBMED,\n    reference_with_citation.date_created,\n    reference_with_citation.DATE_LAST_MODIFIED_IN_PUBMED,\n    reference_with_citation.date_published,\n    reference_with_citation.date_published_start,\n    reference_with_citation.date_published_end,\n    reference_with_citation.date_updated,\n    reference_with_citation.issue_name,\n    reference_with_citation.keywords,\n    reference_with_citation.language,\n    reference_with_citation.open_access,\n    reference_with_citation.page_range,\n    reference_with_citation.plain_language_abstract,\n    reference_with_citation.publisher,\n    reference_with_citation.pubmed_abstract_languages,\n    reference_with_citation.pubmed_publication_status,\n    reference_with_citation.pubmed_types,\n    reference_with_citation.resource_id,\n    reference_with_citation.title \"TITLE\",\n    reference_with_citation.volume,\n    reference_with_citation.CITATION,\n    reference_with_citation.SHORT_CITATION,\n    resource.title \\\"RESOURCE_TITLE\\\"\n    FROM reference_with_citation reference_with_citation\n    LEFT OUTER JOIN resource resource ON cast(reference_with_citation.resource_id as string) = resource.resource_id\n    EMIT CHANGES;\n\n-- Create the existing private index (unchanged)\nCREATE TABLE reference_joined WITH (\n    PARTITIONS = 1,\n    KAFKA_TOPIC = 'reference_joined',\n    VALUE_FORMAT='JSON',\n    KEY_FORMAT='JSON'\n  ) AS SELECT\n    reference_mod_reference_types.reference_id \\\"reference_id\\\",\n    reference_mod_reference_types.curie \\\"curie\\\",\n    reference_mod_reference_types.abstract \\\"abstract\\\",\n    reference_mod_reference_types.category \\\"category\\\",\n    reference_mod_reference_types.date_arrived_in_pubmed \\\"date_arrived_in_pubmed\\\",\n    reference_mod_reference_types.date_created \\\"date_created\\\",\n    reference_mod_reference_types.date_last_modified_in_pubmed \\\"date_last_modified_in_pubmed\\\",\n    reference_mod_reference_types.date_published \\\"date_published\\\",\n    reference_mod_reference_types.date_published_start \\\"date_published_start\\\",\n    reference_mod_reference_types.date_published_end \\\"date_published_end\\\",\n    reference_mod_reference_types.date_updated \\\"date_updated\\\",\n    reference_mod_reference_types.issue_name \\\"issue_name\\\",\n    reference_mod_reference_types.keywords \\\"keywords\\\",\n    reference_mod_reference_types.language \\\"language\\\",\n    reference_mod_reference_types.open_access \\\"open_access\\\",\n    reference_mod_reference_types.page_range \\\"page_range\\\",\n    reference_mod_reference_types.plain_language_abstract \\\"plain_language_abstract\\\",\n    reference_mod_reference_types.publisher \\\"publisher\\\",\n    reference_mod_reference_types.pubmed_abstract_languages \\\"pubmed_abstract_languages\\\",\n    reference_mod_reference_types.pubmed_publication_status \\\"pubmed_publication_status\\\",\n    reference_mod_reference_types.pubmed_types \\\"pubmed_types\\\",\n    reference_mod_reference_types.resource_id \\\"resource_id\\\",\n    reference_mod_reference_types.title \\\"title\\\",\n    reference_mod_reference_types.volume \\\"volume\\\",\n    reference_mod_reference_types.citation \\\"citation\\\",\n    reference_mod_reference_types.short_citation \\\"short_citation\\\",\n    reference_mod_reference_types.cross_references \\\"cross_references\\\",\n    reference_mod_reference_types.authors \\\"authors\\\",\n    reference_mod_reference_types.mods_in_corpus \\\"mods_in_corpus\\\",\n    reference_mod_reference_types.mods_needs_review \\\"mods_needs_review\\\",\n    reference_mod_reference_types.mods_in_corpus_or_needs_review \\\"mods_in_corpus_or_needs_review\\\",\n    reference_mod_reference_types.obsolete_curies \\\"obsolete_curies\\\",\n    reference_mod_reference_types.label \\\"mod_reference_types\\\",\n    topic_entity_tags.topic_entity_tags \\\"topic_entity_tags\\\",\n    reference_workflow_tags.workflow_tags \\\"workflow_tags\\\"\n    FROM reference_mod_reference_types reference_mod_reference_types\n    LEFT OUTER JOIN topic_entity_tags topic_entity_tags ON\n    reference_mod_reference_types.reference_id = topic_entity_tags.reference_id\n    LEFT OUTER JOIN reference_workflow_tags reference_workflow_tags ON reference_mod_reference_types.reference_id = reference_workflow_tags.reference_id;\n\n-- Create the new public index with limited fields\nCREATE TABLE public_reference_joined WITH (\n    PARTITIONS = 1,\n    KAFKA_TOPIC = 'public_reference_joined',\n    VALUE_FORMAT='JSON',\n    KEY_FORMAT='JSON'\n  ) AS SELECT\n    reference_with_resource.REFERENCE_ID \\\"reference_id\\\",\n    reference_with_resource.curie \\\"curie\\\",\n    reference_with_resource.TITLE \\\"title\\\",\n    reference_with_resource.abstract \\\"abstract\\\",\n    reference_with_resource.category \\\"category\\\",\n    reference_with_resource.pubmed_types \\\"pubmed_types\\\",\n    reference_with_resource.RESOURCE_TITLE \\\"resource_title\\\",\n    reference_with_resource.volume \\\"volume\\\",\n    reference_with_resource.issue_name \\\"issue_name\\\",\n    reference_with_resource.page_range \\\"page_range\\\",\n    reference_with_resource.publisher \\\"publisher\\\",\n    reference_with_resource.language \\\"language\\\",\n    reference_with_resource.date_published \\\"date_published\\\",\n    reference_with_resource.pubmed_publication_status \\\"pubmed_publication_status\\\",\n    reference_with_resource.DATE_ARRIVED_IN_PUBMED \\\"date_arrived_in_pubmed\\\",\n    reference_with_resource.DATE_LAST_MODIFIED_IN_PUBMED \\\"date_last_modified_in_pubmed\\\",\n    reference_with_resource.date_created \\\"date_created\\\",\n    reference_with_resource.keywords \\\"keywords\\\",\n    reference_with_resource.CITATION \\\"citation\\\",\n    cross_references.cross_references \\\"cross_references\\\",\n    authors.authors \\\"authors\\\",\n    reference_relations.relations \\\"relations\\\",\n    copyright_licenses.copyright_license \\\"copyright_license\\\",\n    mesh_terms.mesh_terms \\\"mesh_terms\\\"\n    FROM reference_with_resource reference_with_resource\n    LEFT OUTER JOIN cross_references cross_references ON reference_with_resource.REFERENCE_ID = cross_references.REFERENCE_ID\n    LEFT OUTER JOIN authors authors ON reference_with_resource.REFERENCE_ID = authors.REFERENCE_ID\n    LEFT OUTER JOIN reference_relations reference_relations ON reference_with_resource.REFERENCE_ID = reference_relations.REFERENCE_ID\n    LEFT OUTER JOIN copyright_licenses copyright_licenses ON reference_with_resource.REFERENCE_ID = copyright_licenses.REFERENCE_ID\n    LEFT OUTER JOIN mesh_terms mesh_terms ON reference_with_resource.REFERENCE_ID = mesh_terms.REFERENCE_ID;", "streamsProperties": {}}