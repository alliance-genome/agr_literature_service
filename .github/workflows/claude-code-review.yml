name: Claude Code Review

on:
  pull_request:
    types: [opened]
    branches:
      - main
  issue_comment:
    types: [created]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    if: |
      github.actor != 'pjhale' &&
      github.actor != 'claude[bot]' && (
        github.event_name == 'pull_request' ||
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Calculate PR size and skip trivial changes
        id: pr_size
        if: github.event_name == 'pull_request'
        run: |
          set -eo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          DIFF_STATS=$(git diff --numstat "$BASE_SHA".."$HEAD_SHA" | grep -E '^[0-9]+\s+[0-9]+' || true)
          TOTAL=$(echo "$DIFF_STATS" | awk '{s+=$1+$2} END {print s+0}')
          echo "total_changes=$TOTAL" >> $GITHUB_OUTPUT
          if (( 10#${TOTAL:-0} <= 3 )); then
            echo "skip_review=true" >> $GITHUB_OUTPUT
          else
            echo "skip_review=false" >> $GITHUB_OUTPUT
          fi

      - name: Post skip message
        if: github.event_name == 'pull_request' && steps.pr_size.outputs.skip_review == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `**Claude Code Review Skipped** — only **${{ steps.pr_size.outputs.total_changes }}** lines changed (<= 3). Comment \`@claude review my changes\` to request one.`
            })

      - name: Check if review needed
        id: should_review
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ steps.pr_size.outputs.skip_review }}" != "true" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials (OIDC)
        if: steps.should_review.outputs.run == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CLAUDE_CODE_PR_LITERATURE_ROLE_ARN }}
          aws-region: us-east-1
          role-duration-seconds: 1800

      - name: Get database configuration from AWS
        if: steps.should_review.outputs.run == 'true'
        id: db-config
        run: |
          set -euo pipefail

          # Shared config provides SSM instance ID
          CONFIG=$(aws secretsmanager get-secret-value \
            --secret-id /claude-code-pr/config \
            --query SecretString --output text)
          echo "::add-mask::$CONFIG"
          SSM_INSTANCE_ID=$(echo "$CONFIG" | jq -r .ssm_instance_id)

          # Literature-specific config provides DB connection details
          LIT_CONFIG=$(aws secretsmanager get-secret-value \
            --secret-id /claude-code-pr/agr_literature_service/db_credentials \
            --query SecretString --output text)
          echo "::add-mask::$LIT_CONFIG"
          DB_HOST=$(echo "$LIT_CONFIG" | jq -r .db_host)
          DB_PORT=$(echo "$LIT_CONFIG" | jq -r .db_port)
          DB_NAME=$(echo "$LIT_CONFIG" | jq -r .db_name)
          DB_USER=$(echo "$LIT_CONFIG" | jq -r .db_user)

          for var in SSM_INSTANCE_ID DB_HOST DB_PORT DB_NAME DB_USER; do
            if [ -z "${!var}" ] || [ "${!var}" = "null" ]; then
              echo "::error::Missing config field: $var"
              exit 1
            fi
          done
          echo "::add-mask::$DB_HOST"
          echo "::add-mask::$DB_PORT"
          echo "::add-mask::$SSM_INSTANCE_ID"
          echo "::add-mask::$DB_USER"
          echo "::add-mask::$DB_NAME"
          echo "ssm_instance_id=$SSM_INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "db_host=$DB_HOST" >> $GITHUB_OUTPUT
          echo "db_port=$DB_PORT" >> $GITHUB_OUTPUT
          echo "db_name=$DB_NAME" >> $GITHUB_OUTPUT
          echo "db_user=$DB_USER" >> $GITHUB_OUTPUT

      - name: Cache SSM Plugin
        id: cache-ssm-plugin
        if: steps.should_review.outputs.run == 'true'
        uses: actions/cache@v4
        with:
          path: /tmp/session-manager-plugin.deb
          key: ${{ runner.os }}-ssm-plugin

      - name: Install SSM Plugin and PostgreSQL client
        if: steps.should_review.outputs.run == 'true'
        run: |
          set -euo pipefail
          if [ "${{ steps.cache-ssm-plugin.outputs.cache-hit }}" != 'true' ]; then
            curl -fsSL -o /tmp/session-manager-plugin.deb \
              https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb
          fi
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          sudo dpkg -i /tmp/session-manager-plugin.deb || {
            sudo apt-get install -f -y
            sudo dpkg -i /tmp/session-manager-plugin.deb
          }
          session-manager-plugin --version
          pg_isready --version

      - name: Start database tunnel
        if: steps.should_review.outputs.run == 'true'
        id: tunnel
        run: |
          set -euo pipefail
          LOCAL_PORT=$(comm -23 <(seq 5500 6500) <(ss -lnt | awk 'NR>1{print $4}' | awk -F: '{print $NF}' | sort -n) | shuf -n1)
          if nc -z localhost $LOCAL_PORT 2>/dev/null; then
            LOCAL_PORT=$(comm -23 <(seq 5500 6500) <(ss -lnt | awk 'NR>1{print $4}' | awk -F: '{print $NF}' | sort -n) | shuf -n1)
          fi
          echo "local_port=$LOCAL_PORT" >> $GITHUB_OUTPUT

          # Use nohup/disown to keep tunnel alive across steps
          nohup timeout --foreground 30m \
            aws ssm start-session \
            --target ${{ steps.db-config.outputs.ssm_instance_id }} \
            --document-name AWS-StartPortForwardingSessionToRemoteHost \
            --parameters '{"host":["${{ steps.db-config.outputs.db_host }}"],"portNumber":["${{ steps.db-config.outputs.db_port }}"],"localPortNumber":["'$LOCAL_PORT'"]}' \
            > /tmp/ssm_tunnel.log 2>&1 &
          SSM_PID=$!
          disown $SSM_PID
          echo "pid=$SSM_PID" >> $GITHUB_OUTPUT
          sleep 1

          if ! ps -p $SSM_PID >/dev/null 2>&1; then
            echo "::error::SSM session failed to start"
            exit 1
          fi

          for i in $(seq 1 60); do
            if ! ps -p $SSM_PID >/dev/null 2>&1; then
              echo "::error::SSM process crashed"
              exit 1
            fi
            if pg_isready -h localhost -p $LOCAL_PORT -t 2 >/dev/null 2>&1; then
              echo "Database tunnel established on port $LOCAL_PORT"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "::error::Tunnel timeout after 120s"
              kill $SSM_PID || true
              exit 1
            fi
            sleep 2
          done

          # Start keepalive to prevent idle tunnel timeout
          export KEEPALIVE_SSM_PID=$SSM_PID
          export KEEPALIVE_PORT=$LOCAL_PORT
          nohup bash -c '
            while true; do
              if ! ps -p $KEEPALIVE_SSM_PID >/dev/null 2>&1; then exit 0; fi
              pg_isready -h localhost -p $KEEPALIVE_PORT -t 1 >/dev/null 2>&1 || true
              sleep 10
            done
          ' > /tmp/keepalive.log 2>&1 &
          KEEPALIVE_PID=$!
          disown $KEEPALIVE_PID
          echo "keepalive_pid=$KEEPALIVE_PID" >> $GITHUB_OUTPUT

      - name: Get database password
        if: steps.should_review.outputs.run == 'true'
        uses: aws-actions/aws-secretsmanager-get-secrets@v2.0.6
        with:
          secret-ids: |
            DB_CREDS,literature-db-readonly
          parse-json-secrets: true

      - name: Verify database connection
        if: steps.should_review.outputs.run == 'true'
        run: |
          set -euo pipefail
          if [ -z "${DB_CREDS:-}" ]; then
            echo "::error::Failed to retrieve database password"
            exit 1
          fi
          echo "::add-mask::$DB_CREDS"
          echo "DB_PASSWORD=$DB_CREDS" >> $GITHUB_ENV
          PGPASSWORD="$DB_CREDS" psql -h localhost -p ${{ steps.tunnel.outputs.local_port }} \
            -U "${{ steps.db-config.outputs.db_user }}" -d "${{ steps.db-config.outputs.db_name }}" \
            -c "SELECT 1;" >/dev/null 2>&1 || {
              echo "::error::Database connection failed"
              exit 1
            }

      # Auto-review on pull_request events.
      # Per official docs: provide REPO, PR NUMBER, gh pr comment instruction, and --allowedTools.
      - name: Claude Code Review (auto-review)
        uses: anthropics/claude-code-action@v1
        if: github.event_name == 'pull_request' && steps.pr_size.outputs.skip_review != 'true'
        env:
          PGPASSWORD: ${{ env.DB_PASSWORD }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this PR. Focus on correctness, bugs, security, and database performance.
            Only flag issues introduced by the changes, not pre-existing code.
            If the changes look correct, say so briefly.

            You have read-only PostgreSQL access (literature database):
            psql -h localhost -p ${{ steps.tunnel.outputs.local_port }} -U ${{ steps.db-config.outputs.db_user }} -d ${{ steps.db-config.outputs.db_name }} -c 'YOUR SQL HERE'
            (PGPASSWORD is set in the environment.)

            Use `gh pr comment` for top-level feedback.
            Only post GitHub comments — do not submit review text as messages.

          claude_args: |
            --model ${{ vars.CLAUDE_PR_REVIEW_MODEL }}
            --max-turns 10
            --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git diff:*),Bash(git log:*),Bash(psql:*),Read,Glob,Grep"

      # Interactive mode: respond to @claude mentions on PRs.
      # Per official docs: no prompt, no --allowedTools — action auto-detects tag mode.
      - name: Claude Code Review (interactive)
        uses: anthropics/claude-code-action@v1
        if: github.event_name == 'issue_comment'
        env:
          PGPASSWORD: ${{ env.DB_PASSWORD }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@claude"
          claude_args: |
            --model ${{ vars.CLAUDE_PR_REVIEW_MODEL }}
            --max-turns 10

      - name: Cleanup
        if: always() && steps.tunnel.outputs.pid != ''
        run: |
          # Kill keepalive
          if [ -n "${{ steps.tunnel.outputs.keepalive_pid }}" ] && ps -p ${{ steps.tunnel.outputs.keepalive_pid }} >/dev/null 2>&1; then
            kill ${{ steps.tunnel.outputs.keepalive_pid }} 2>/dev/null || true
          fi
          # Kill tunnel
          if [ -n "${{ steps.tunnel.outputs.pid }}" ] && ps -p ${{ steps.tunnel.outputs.pid }} >/dev/null 2>&1; then
            kill -TERM -- -${{ steps.tunnel.outputs.pid }} 2>/dev/null || true
          fi
          SESSIONS=$(aws ssm describe-sessions --state Active \
            --filters "key=Target,value=${{ steps.db-config.outputs.ssm_instance_id }}" \
            --query "Sessions[?DocumentName=='AWS-StartPortForwardingSessionToRemoteHost'].SessionId" \
            --output text 2>/dev/null || true)
          for session in $SESSIONS; do
            aws ssm terminate-session --session-id $session 2>/dev/null || true
          done
